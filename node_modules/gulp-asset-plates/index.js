'use strict';
var through = require('through2'),
    plates = require('plates');

module.exports = function(prefix, args) {
	var context = { 'prefix': prefix }

	// create a stream through which each file will pass
	return through.obj(function(file, enc, callback) {

		if (file.isNull()) {
			this.push(file);
			// do nothing if no contents
			return callback();
		}

		if (file.isStream()) {
			this.emit('error', new gutil.PluginError('gulp-asset-plates', 'Streaming not supported'));
			return callback();
		}

		if (file.isBuffer()) {

			var text = String(file.contents);

			for (var a in args) {
				var map = plates.Map();

				map.where(args[a].attr).has(args[a].selector).use(function(data, value, tag_body){
					return prefix + '/' + value;
				}).as(args[a].attr);

				text = plates.bind(text, context, map)
			}

			file.contents = new Buffer(text);

			return callback(null, file);
		}
	});
}; 